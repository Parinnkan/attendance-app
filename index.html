<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบลงเวลาทำงาน</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ลงเวลาทำงาน</h1>
      <p class="status-text">เครือข่าย&nbsp;<span id="networkStatus">ตรวจสอบ...</span></p>

      <!-- User bar -->
      <div id="userBar" class="user-bar" style="display:none;">
        <div>
          <span id="currentUserName" class="user-name">-</span>
          <span id="currentUserRole" class="role-badge">-</span>
        </div>
        <button id="logoutBtn" class="btn btn-ghost">ออกจากระบบ</button>
      </div>
    </div>

    <!-- AUTH SECTION -->
    <div id="authSection" class="auth-section">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">เข้าสู่ระบบ</button>
        <button class="auth-tab" data-tab="register">ลงทะเบียน</button>
      </div>

      <div id="loginPanel">
        <div id="authAlert"></div>
        <div class="form-grid">
          <div class="form-item">
            <label>อีเมล</label>
            <input id="loginEmail" type="email" placeholder="your@email.com">
          </div>
          <div class="form-item">
            <label>รหัสผ่าน</label>
            <input id="loginPassword" type="password" placeholder="รหัสผ่าน">
          </div>
        </div>
        <button id="loginBtn" class="btn w-full">เข้าสู่ระบบ</button>
        <p class="hint mt-2">แอดมินเริ่มต้น: <code>admin</code> / <code>admin</code></p>
      </div>

      <div id="registerPanel" style="display:none;">
        <div id="regAlert"></div>
        <div class="form-grid">
          <div class="form-item">
            <label>ชื่อ</label>
            <input id="regFirstName" type="text" placeholder="ชื่อ">
          </div>
          <div class="form-item">
            <label>สกุล</label>
            <input id="regLastName" type="text" placeholder="นามสกุล">
          </div>
          <div class="form-item">
            <label>อีเมล</label>
            <input id="regEmail" type="email" placeholder="your@email.com">
          </div>
          <div class="form-item">
            <label>รหัสผ่าน</label>
            <input id="regPassword" type="password" placeholder="อย่างน้อย 6 ตัวอักษร">
          </div>
        </div>
        <button id="registerBtn" class="btn w-full">ลงทะเบียนผู้ใช้</button>
      </div>
    </div>

    <div class="main-tabs" id="appTabs" style="display:none;">
      <button class="main-tab active" data-tab="attendance">ลงเวลา</button>
      <button class="main-tab" data-tab="history">ประวัติ</button>
    </div>

    <div class="main-content" id="appContent" style="display:none;">
      <!-- TAB: ลงเวลา -->
      <div id="attendanceTab">
        <div id="alertContainer"></div>

        <div class="camera-section">
          <div class="camera-container">
            <video id="video" autoplay muted></video>
            <canvas id="snapshotCanvas" style="display:none;"></canvas>
            <div class="face-overlay" id="faceOverlay"></div>
          </div>
          <div class="controls">
            <button class="btn" id="startCamera">เปิดกล้อง</button>
            <button class="btn check-in" id="checkInBtn" disabled>เข้างาน</button>
            <button class="btn check-out" id="checkOutBtn" disabled>ออกงาน</button>
          </div>
        </div>

        <div class="loading" id="loadingIndicator">
          <div class="spinner"></div>
          <p>กำลังประมวลผล...</p>
        </div>

        <div class="info-section">
          <div class="info-grid">
            <div class="info-item">
              <h3>วันที่</h3><p id="currentDate">-</p>
            </div>
            <div class="info-item">
              <h3>เวลา</h3><p id="currentTime">-</p>
            </div>
            <div class="info-item">
              <h3>สถานะ</h3><p id="currentStatus">ยังไม่ได้ลงเวลา</p>
            </div>
            <div class="info-item">
              <h3>การตรวจสอบ</h3><p id="faceStatus">ยังไม่ได้ตรวจสอบ</p>
            </div>
          </div>

          <div class="location-info">
            <h3>ข้อมูลตำแหน่ง</h3>
            <p id="locationInfo">กำลังหาตำแหน่ง...</p>
            <p id="locationAccuracy"></p>
          </div>

          <div class="daily-summary" id="dailySummary">
            <h3>สรุปวันนี้</h3>
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">เข้างาน:</span>
                <span class="summary-value" id="todayCheckIn">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">ออกงาน:</span>
                <span class="summary-value" id="todayCheckOut">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ประวัติ -->
      <div id="historyTab" style="display:none;">
        <div class="history-section">
          <h3>ประวัติการลงเวลา</h3>
          <div class="history-tabs">
            <button class="history-tab active" data-type="all">ทั้งหมด</button>
            <button class="history-tab" data-type="check-in">เข้างาน</button>
            <button class="history-tab" data-type="check-out">ออกงาน</button>
          </div>

          <!-- ตัวกรองวันที่ -->
          <div class="history-filters">
            <label for="historyDate" class="history-date-label">เลือกวันที่:</label>
            <input type="date" id="historyDate" class="history-date-input" />
            <button class="history-action" id="historyToday">วันนี้</button>
            <button class="history-action secondary" id="historyClear">ล้าง</button>
          </div>

          <div id="attendanceHistory"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal บันทึกงานตอนออกงาน -->
  <div id="notesModal" class="modal" style="display:none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h3 class="modal-title">สรุปงานวันนี้ (ใส่ตอนออกงาน)</h3>
      <p class="modal-subtitle">ตัวอย่าง: รายงานผลกิจกรรม, ประชุมกับ..., ทำเอกสาร..., พัฒนาโมดูล...</p>
      <textarea id="checkoutNotes" class="modal-textarea" rows="6" maxlength="1000" placeholder="พิมพ์บันทึกงานวันนี้... (ไม่บังคับ)"></textarea>
      <div class="modal-actions">
        <button id="saveAndCheckout" class="btn modal-btn primary">บันทึก & ออกงาน</button>
        <button id="skipAndCheckout" class="btn modal-btn">ข้าม & ออกงาน</button>
        <button id="cancelCheckout" class="btn modal-btn secondary">ยกเลิก</button>
      </div>
      <div class="modal-hint"><span id="notesCount">0</span>/1000 ตัวอักษร</div>
    </div>
  </div>

  <script src="main.js"></script>

  <script>
    // Auth tabs
    (function () {
      function setActiveAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
        tab.classList.add('active');
      }
      function showAuth(name) {
        document.getElementById('loginPanel').style.display = name==='login' ? '' : 'none';
        document.getElementById('registerPanel').style.display = name==='register' ? '' : 'none';
      }
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', function(){
            setActiveAuthTab(this);
            showAuth(this.getAttribute('data-tab'));
          });
        });
      });
    })();

    // Main tab switch
    (function () {
      function setActiveMainTab(tab) {
        document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
        tab.classList.add('active');
      }
      function showTab(tabName) {
        document.getElementById('attendanceTab').style.display = tabName === 'attendance' ? '' : 'none';
        document.getElementById('historyTab').style.display = tabName === 'history' ? '' : 'none';
      }
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.main-tab').forEach(tab => {
          tab.addEventListener('click', function () {
            setActiveMainTab(this);
            showTab(this.getAttribute('data-tab'));
          });
        });
      });
    })();

    // History sub-tab + date filter
    (function () {
      function setActiveTab(tab) {
        document.querySelectorAll('.history-tab').forEach(btn => btn.classList.remove('active'));
        tab.addEventListener; tab.classList.add('active');
      }
      function getSelectedType() {
        const active = document.querySelector('.history-tab.active');
        return active ? active.getAttribute('data-type') : 'all';
      }
      function reload() {
        const type = getSelectedType();
        const dateInput = document.getElementById('historyDate');
        const dateStr = dateInput && dateInput.value ? dateInput.value : null;
        if (window.attendanceSystem && window.attendanceSystem.loadAttendanceHistory) {
          window.attendanceSystem.loadAttendanceHistory(type, dateStr);
        }
      }
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.history-tab').forEach(tab => {
          tab.addEventListener('click', function () {
            document.querySelectorAll('.history-tab').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            reload();
          });
        });

        const dateInput = document.getElementById('historyDate');
        const btnToday = document.getElementById('historyToday');
        const btnClear = document.getElementById('historyClear');

        if (dateInput) dateInput.addEventListener('change', reload);
        if (btnToday) btnToday.addEventListener('click', () => {
          const tz = new Date().getTimezoneOffset() * 60000;
          dateInput.value = new Date(Date.now() - tz).toISOString().slice(0, 10);
          reload();
        });
        if (btnClear) btnClear.addEventListener('click', () => {
          dateInput.value = '';
          reload();
        });
      });
    })();
  </script>
</body>
</html>
